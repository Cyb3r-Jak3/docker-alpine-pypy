name: Generate Release

on:
  workflow_dispatch:
    inputs:
      pypy_base:
          description: 'Comma seperated base version: 2.7,3.9,3.10'
          required: true
      pypy_version:
          description: 'PyPy version to download: 7.3.13'
          required: true

jobs:
  generate-release:
    runs-on: ubuntu-latest
    permissions:
        contents: write
        id-token: write
        attestations: write
    env:
      TAG: "${{ github.event.inputs.pypy_version }}-${{ github.event.inputs.pypy_base }}"
    steps:
        - name: Checkout code
          uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        - name: Release Info
          run: |
              echo "::notice title=PYPY_BASE::${{ github.event.inputs.pypy_base }}"
              echo "::notice title=PYPY_VERSION:: ${{ github.event.inputs.pypy_version }}"

        - name: Prep Release
          run: python .github/release.py
          env:
            PYPY_BASE: ${{ github.event.inputs.pypy_base }}
            PYPY_VERSION: ${{ github.event.inputs.pypy_version }}

        - name: Generate Checksums
          run: |
            ls -la *.tar.bz2*
            sha256sum *.tar.bz2 > checksums.sha256
            gpg --no-tty --keyserver hkps://keys.openpgp.org --auto-key-locate keyserver --locate-keys releases@cyberjake.xyz
            find . -iname "*.tar.bz2" -type f -exec  bash -c "echo verifying {}; gpg --verify {}.sig {} " \;

        - name: Create tag
          uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
          with:
            script: |
              github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'refs/tags/${{ env.TAG }}',
                sha: context.sha
              })
        
        - name: Release
          uses: crazy-max/ghaction-github-release@e6ee649c47c739f3a3948930a96c723bb553517d # v2
          with:
            draft: true
            tag_name: ${{ env.TAG }}
            files: |
              *.tar.bz2
              *.tar.bz2.sig
              checksums.sha256

        - uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
          with:
            subject-checksums: checksums.sha256
